<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Geospatial Jobs Visualization</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"/>
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/deck.gl@8.9.27/dist.min.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <style>
    :root {
      --bg:#0F1115; --panel:#131722; --stroke:#242634;
      --text:#E7E9EE; --muted:#9AA0AB; --accent:#5563FF;
    }
    html,body { height:100%; }
    body {
      margin:0; background:var(--bg); color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      overflow:hidden;
    }
    #map { position:absolute; inset:0; }
    .bg-panel{ background:var(--panel); }
    .text-muted{ color:var(--muted); }
    .border-stroke{ border-color:var(--stroke); }
    .bg-accent{ background:var(--accent); }
    .outline-focus:focus{ outline:2px solid var(--accent); outline-offset:2px; }
    .sidebar{ position:absolute; inset:0 auto 0 0; width:340px; z-index:10; box-shadow:2px 0 12px rgba(0,0,0,.35); }
    .legend { display:flex; height:16px; border-radius:6px; overflow:hidden; border:1px solid var(--stroke); }
    .tooltip {
      position:absolute; z-index:50; pointer-events:none;
      background:var(--panel); border:1px solid var(--stroke);
      border-radius:10px; padding:10px; font-size:13px; max-width:280px;
      transform:translate(10px, -10px);
    }
    .region-btn{
      background:var(--panel); border:1px solid var(--stroke); color:var(--muted);
      padding:6px 12px; border-radius:8px; cursor:pointer; font-size:13px;
    }
    .region-btn.active{ background:var(--accent); color:white; }
    .pill{ padding:.25rem .5rem; border:1px solid var(--stroke); border-radius:.5rem; font-size:.75rem; color:var(--muted);}
  </style>
</head>
<body>
  <aside class="sidebar bg-panel flex flex-col">
    <header class="p-4 border-b border-stroke">
      <h1 class="text-xl font-semibold">Geospatial</h1>
      <div class="flex gap-2 mt-3 text-xs">
        <span class="pill bg-accent text-white border-0">Map Visualization</span>
        <span class="pill">Earth Observation jobs</span>
        <span class="pill">Vector Enrichment jobs</span>
      </div>
    </header>

    <div class="p-4 overflow-y-auto grow space-y-4">
      <section class="bg-panel border border-stroke rounded-2xl p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-semibold">Layers</h2>
          <button id="btnAddLayer" class="bg-accent text-white text-sm px-3 py-1 rounded-md">Add Layer</button>
        </div>

        <div class="border border-stroke rounded-xl p-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <input id="layerVisible" type="checkbox" checked class="accent-indigo-500"/>
              <span>Job Points</span>
            </div>
            <span class="text-muted text-xs">Scatterplot</span>
          </div>

          <div class="mt-3 grid grid-cols-1 gap-3">
            <div>
              <label class="text-sm text-muted">Color based on</label>
              <select id="attrSelect" class="mt-1 w-full bg-panel border border-stroke rounded-md px-3 py-2 outline-focus">
                <option value="count">count</option>
                <option value="salary">salary</option>
                <option value="experience">experience</option>
              </select>
            </div>

            <div>
              <label class="text-sm text-muted">Classification</label>
              <select id="classSelect" class="mt-1 w-full bg-panel border border-stroke rounded-md px-3 py-2 outline-focus">
                <option value="quantile">Quantile (Q5)</option>
                <option value="equal">Equal Interval</option>
              </select>
            </div>

            <div>
              <div class="legend" id="legendRamp"></div>
              <div id="legendLabels" class="flex justify-between text-[11px] text-muted mt-1">
                <span>low</span><span>high</span>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-muted">Radius</label>
                <input id="radiusRange" type="range" min="3" max="12" value="6" class="w-full"/>
              </div>
              <div>
                <label class="text-sm text-muted">Opacity</label>
                <input id="opacityRange" type="range" min="30" max="100" value="75" class="w-full"/>
              </div>
            </div>

            <label class="inline-flex items-center gap-2 text-sm">
              <input id="blendToggle" type="checkbox" checked class="accent-indigo-500"/>
              <span class="text-muted">Additive blending (glow)</span>
            </label>
          </div>
        </div>
      </section>

      <section class="bg-panel border border-stroke rounded-2xl p-4">
        <h2 class="font-semibold mb-2">Paste Job Data</h2>
        <p class="text-muted text-sm mb-3">Paste tabular job data (e.g. from Excel) to visualize on map.</p>

        <textarea id="jobDataInput" class="w-full h-32 bg-panel border border-stroke rounded-md px-3 py-2 outline-focus" 
          placeholder="Paste tabular data here (e.g. Excel). Must include location (city/country) or lat/lon columns."></textarea>

        <div class="grid grid-cols-2 gap-3 mt-3 mb-3">
          <div>
            <label class="text-sm text-muted">Location Column</label>
            <select id="locationColumn" class="mt-1 w-full bg-panel border border-stroke rounded-md px-3 py-2 outline-focus">
              <option value="location">location</option>
              <option value="city">city</option>
              <option value="address">address</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-muted">Title Column</label>
            <select id="titleColumn" class="mt-1 w-full bg-panel border border-stroke rounded-md px-3 py-2 outline-focus">
              <option value="title">title</option>
              <option value="job_title">job_title</option>
              <option value="role">role</option>
            </select>
          </div>
        </div>

        <button id="visualizeJobsBtn" class="bg-accent text-white w-full py-2 rounded-md">Visualize on Map</button>
      </section>

      <section class="bg-panel border border-stroke rounded-2xl p-4">
        <h2 class="font-semibold mb-2">Filters</h2>
        <div class="grid grid-cols-1 gap-3">
          <select id="countryFilter" class="bg-panel border border-stroke rounded-md px-3 py-2">
            <option value="">All countries</option>
            <option value="NL">Netherlands</option>
            <option value="DE">Germany</option>
            <option value="FR">France</option>
            <option value="BE">Belgium</option>
            <option value="UK">United Kingdom</option>
          </select>
          <input id="searchFilter" class="bg-panel border border-stroke rounded-md px-3 py-2" placeholder="Filter by company or job"/>
        </div>
      </section>
    </div>
  </aside>

  <div class="absolute top-4 left-[360px] z-10 flex gap-2">
    <button class="region-btn active" data-region="fit">Fit to Data</button>
    <button class="region-btn" data-region="europe">Europe</button>
    <button class="region-btn" data-region="nl">Netherlands</button>
  </div>

  <div id="map"></div>

  <div id="tooltip" class="tooltip" style="display:none;"></div>

  <script>
    // Note: This won't work directly due to CORS and LinkedIn's protections
    // You would need a backend proxy to handle the actual scraping
    const CONFIG = {
      STYLE_URL: "https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",
      PALETTE: ["#6C1D6B","#9C2C7A","#D4475D","#F07E2E","#FFA600"],
      ATTR_DEFAULT: "count",
      MAX_POINTS: 200000
    };

    const hexToRgb = (hex) => {
      const m = hex.replace("#",""); return [
        parseInt(m.substring(0,2),16),
        parseInt(m.substring(2,4),16),
        parseInt(m.substring(4,6),16)
      ];
    };
    const quantiles = (arr, k) => {
      const a = [...arr].sort((x,y)=>x-y);
      const q = []; for(let i=1;i<k;i++){
        const p = i/k;
        const idx = (a.length-1)*p;
        const lo = Math.floor(idx), hi = Math.ceil(idx);
        const v = lo===hi ? a[lo] : a[lo] + (a[hi]-a[lo])*(idx-lo);
        q.push(v);
      }
      return q;
    };
    const equalBreaks = (arr, k) => {
      const min = Math.min(...arr), max = Math.max(...arr);
      const step = (max-min)/k; const b=[];
      for(let i=1;i<k;i++) b.push(min+step*i);
      return b;
    };
    const classify = (v, breaks) => {
      for(let i=0;i<breaks.length;i++) if(v<=breaks[i]) return i;
      return breaks.length;
    };
    const formatNum = (n) => new Intl.NumberFormat().format(n);

    const map = new maplibregl.Map({
      container: "map",
      style: CONFIG.STYLE_URL,
      center: [5.3, 52.2],
      zoom: 6.2,
      attributionControl: true
    });

    let rawData = null;
    let filtered = null;
    let breaks = null;
    let activeAttr = CONFIG.ATTR_DEFAULT;

    function generateSampleData(){
      // Hardcoded job data with coordinates for given locations
      const jobLocations = [
        { city: "Amsterdam", company: "Leaseweb", lat: 52.3667, lon: 4.8945, job: "SAP Functional Application Manager Authorizations" },
        { city: "Amsterdam", company: "Deloitte", lat: 52.3667, lon: 4.8945, job: "Junior SAP Consultant" },
        { city: "Lieshout", company: "Royal Swinkels", lat: 51.5194, lon: 5.5958, job: "Junior SAP Application Manager" },
        { city: "Utrecht", company: "Billennium", lat: 52.0907, lon: 5.1214, job: "SAP Consultant – Talent Pool (100% Remote)" },
        { city: "Eindhoven", company: "SixteenFifty", lat: 51.4416, lon: 5.4697, job: "SAP MM Support Consultant" }
      ];

      const fc = { type:"FeatureCollection", features:[] };
      
      jobLocations.forEach((loc, i) => {
        fc.features.push({
          type:"Feature",
          geometry: { type:"Point", coordinates:[loc.lon, loc.lat] },
          properties: {
            id: i,
            name: loc.job,
            company: loc.company,
            country: "NL",
            count: 1,
            salary: 60000 + (Math.random()*30000|0), // Random salary between 60k-90k
            experience: 2 + (Math.random()*3|0) // Random experience between 2-5 years
          }
        });
      });

      return fc;
    }

    const deckOverlay = new deck.MapboxOverlay({ interleaved: true, layers: [] });
    map.addControl(deckOverlay);

    function buildScatter(){
      const radiusPx = +document.getElementById("radiusRange").value;
      const opacity = +document.getElementById("opacityRange").value / 100;
      const additive = document.getElementById("blendToggle").checked;
      const gl = deck.GL;

      return new deck.ScatterplotLayer({
        id:"jobs",
        data: filtered.features,
        getPosition: d => d.geometry.coordinates,
        getRadius: d => radiusPx,
        radiusUnits: "pixels",
        radiusMinPixels: 1,
        radiusMaxPixels: 30,
        opacity,
        pickable: true,
        autoHighlight: true,
        parameters: {
          depthTest:false,
          blend: true,
          blendFunc: additive ? [gl.SRC_ALPHA, gl.ONE] : [gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA],
          blendEquation: gl.FUNC_ADD
        },
        getFillColor: d => {
          const v = Number(d.properties[activeAttr]);
          const cls = classify(v, breaks);
          const rgb = hexToRgb(CONFIG.PALETTE[cls]);
          return [rgb[0], rgb[1], rgb[2], 255];
        },
        onHover: ({x,y,object}) => {
          const t = document.getElementById("tooltip");
          if(object){
            t.style.display = "block";
            t.style.left = x+"px"; t.style.top = y+"px";
            t.innerHTML = `
              <div class="font-semibold">${object.properties.name}</div>
              <div class="text-muted">${object.properties.company}</div>
              <div class="mt-1 text-sm">Jobs: <b>${object.properties.count}</b> · Salary: <b>€${formatNum(object.properties.salary)}</b> · Exp: <b>${object.properties.experience}y</b></div>
              <div class="text-[11px] text-muted mt-1">${object.geometry.coordinates[1].toFixed(4)}, ${object.geometry.coordinates[0].toFixed(4)}</div>
            `;
          } else {
            t.style.display = "none";
          }
        },
        onClick: ({object})=>{
          if(!object) return;
          document.getElementById("liKeywords").value = object.properties.name;
          document.getElementById("liLocation").value = countryIsoToName(object.properties.country) || object.properties.country;
          updateLinkedInPreview();
        }
      });
    }

    function countryIsoToName(iso){
      const map = { NL:"Netherlands", DE:"Germany", FR:"France", BE:"Belgium", UK:"United Kingdom", ES:"Spain", IT:"Italy", PL:"Poland", SE:"Sweden", DK:"Denmark" };
      return map[iso];
    }

    function recomputeColoring(){
      const values = filtered.features.map(f => Number(f.properties[activeAttr])).filter(Number.isFinite);
      const method = document.getElementById("classSelect").value;
      breaks = method === "equal" ? equalBreaks(values, CONFIG.PALETTE.length) : quantiles(values, CONFIG.PALETTE.length);
      const ramp = document.getElementById("legendRamp");
      ramp.innerHTML = CONFIG.PALETTE.map(c=>`<div style="flex:1;background:${c}"></div>`).join("");
      const labs = [Math.min(...values), ...breaks, Math.max(...values)];
      const low = formatNum(Math.round(labs[0])); const high = formatNum(Math.round(labs[labs.length-1]));
      document.getElementById("legendLabels").innerHTML = `<span>${low}</span><span>${high}</span>`;
    }

    function fitTo(fc, pad=100){
      const bbox = turf.bbox(fc);
      map.fitBounds([[bbox[0],bbox[1]],[bbox[2],bbox[3]]], { padding: pad, duration: 800 });
    }
    function flyRegion(tag){
      if(tag==="europe") map.fitBounds([[-25,35],[45,72]],{padding:50});
      else if(tag==="nl") map.fitBounds([[3.2,50.5],[7.3,53.7]],{padding:60});
      else if(tag==="us") map.fitBounds([[-125,24],[-66,50]],{padding:50});
      else fitTo(filtered);
    }

    function applyFilters(){
      const iso = document.getElementById("countryFilter").value;
      const q = document.getElementById("searchFilter").value.trim().toLowerCase();
      filtered = {
        type:"FeatureCollection",
        features: rawData.features.filter(f=>{
          const okCountry = !iso || f.properties.country===iso;
          const inText = !q || (f.properties.name.toLowerCase().includes(q) || f.properties.company.toLowerCase().includes(q));
          return okCountry && inText;
        })
      };
    }

    function buildLinkedInUrl(){
      const keywords = encodeURIComponent(document.getElementById("liKeywords").value.trim());
      const location = encodeURIComponent(document.getElementById("liLocation").value.trim());
      const seconds = document.getElementById("liDate").value;
      const km = Number(document.getElementById("liDistanceKm").value || 0);
      const miles = Math.round(km * 0.621371);

      const exps = [...document.querySelectorAll(".li-exp:checked")].map(cb=>cb.value).join(",");
      const types = [...document.querySelectorAll(".li-type:checked")].map(cb=>cb.value).join(",");
      const wt = document.querySelector("input[name='li-wt']:checked")?.value || "";

      const params = new URLSearchParams();
      if(keywords) params.set("keywords", decodeURIComponent(keywords));
      if(location) params.set("location", decodeURIComponent(location));
      if(miles>0) params.set("distance", String(miles));
      if(seconds) params.set("f_TPR","r"+seconds);
      if(exps) params.set("f_E", exps);
      if(types) params.set("f_JT", types);
      if(wt) params.set("f_WT", wt);
      params.set("sortBy","R");

      return "https://www.linkedin.com/jobs/search/?"+params.toString();
    }
    function updateLinkedInPreview(){
      const url = buildLinkedInUrl();
      const a = document.getElementById("liPreview");
      a.textContent = url;
      a.href = url;
    }

    document.getElementById("visualizeJobsBtn").addEventListener("click", async () => {
      try {
        const dataText = document.getElementById("jobDataInput").value.trim();
        if (!dataText) {
          alert("Please paste some job data first");
          return;
        }

        // Parse tabular data (TSV or CSV)
        const rows = Papa.parse(dataText, { header: true }).data;
        if (rows.length === 0) {
          alert("No valid data found - make sure it's tabular data with headers");
          return;
        }

        const locationCol = document.getElementById("locationColumn").value;
        const titleCol = document.getElementById("titleColumn").value;
        
        // Geocode locations and create features
        const features = [];
        const geocodeCache = {};
        
        for (const row of rows) {
          if (!row[locationCol] || !row[titleCol]) continue;

          // Check cache for already geocoded locations
          if (!geocodeCache[row[locationCol]]) {
            const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(row[locationCol])}`;
            const geocodeRes = await fetch(geocodeUrl);
            const geocodeData = await geocodeRes.json();
            
            if (geocodeData.length > 0) {
              const { lat, lon } = geocodeData[0];
              geocodeCache[row[locationCol]] = { 
                coordinates: [parseFloat(lon), parseFloat(lat)] 
              };
            }
          }

          if (geocodeCache[row[locationCol]]) {
            features.push({
              type: "Feature",
              geometry: {
                type: "Point",
                coordinates: geocodeCache[row[locationCol]].coordinates
              },
              properties: {
                id: features.length,
                name: row[titleCol],
                company: row.company || row.employer || "",
                country: row.country || "",
                count: 1,
                salary: Number(row.salary) || 0,
                experience: Number(row.experience) || 0
              }
            });
          }
        }

        if (features.length === 0) {
          alert("No valid locations found - check your location column");
          return;
        }

        // Update map with new data
        rawData = { type: "FeatureCollection", features };
        applyFilters();
        refreshLayer();
        fitTo(filtered, 100);

      } catch (err) {
        console.error("Error:", err);
        alert("Failed to process job data");
      }
    });

    function refreshLayer(){
      recomputeColoring();
      deckOverlay.setProps({ layers:[buildScatter()] });
    }

    document.getElementById("layerVisible").addEventListener("change", (e)=>{
      deckOverlay.setProps({ layers: e.target.checked ? [buildScatter()] : [] });
    });
    document.getElementById("attrSelect").addEventListener("change", (e)=>{
      activeAttr = e.target.value; refreshLayer();
    });
    document.getElementById("classSelect").addEventListener("change", refreshLayer);
    document.getElementById("radiusRange").addEventListener("input", refreshLayer);
    document.getElementById("opacityRange").addEventListener("input", refreshLayer);
    document.getElementById("blendToggle").addEventListener("change", refreshLayer);

    document.getElementById("countryFilter").addEventListener("change", ()=>{
      applyFilters(); refreshLayer(); fitTo(filtered, 80);
    });
    document.getElementById("searchFilter").addEventListener("input", ()=>{
      applyFilters(); refreshLayer();
    });

    document.querySelectorAll(".region-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".region-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        flyRegion(btn.dataset.region);
      });
    });

    function csvToGeoJSON(csvRows){
      const header = Object.keys(csvRows[0] || {}).reduce((m,k)=>{ m[k.toLowerCase()] = k; return m; },{});
      const lonKey = header.longitude || header.lon || header.lng || header.x;
      const latKey = header.latitude || header.lat || header.y;
      if (!lonKey || !latKey) throw new Error("CSV must include lon/lat columns");

      const features = csvRows.map((r,i)=>{
        const lon = Number(r[lonKey]), lat = Number(r[latKey]);
        if (!isFinite(lon) || !isFinite(lat)) return null;
        return {
          type:"Feature",
          geometry:{ type:"Point", coordinates:[lon,lat] },
          properties:{
            id: r.id ?? i,
            name: r.name ?? r.title ?? "Job",
            company: r.company ?? r.employer ?? "",
            country: r.country ?? "",
            count: Number(r.count ?? 1) || 1,
            salary: Number(r.salary ?? r.pay ?? 0) || 0,
            experience: Number(r.experience ?? r.exp ?? 0) || 0
          }
        };
      }).filter(Boolean);

      return { type:"FeatureCollection", features };
    }

    async function loadGeoDataFromUrl(url){
      const res = await fetch(url);
      const text = await res.text();
      if (url.toLowerCase().endsWith(".csv") || text.trim().split("\n")[0].includes(",")) {
        const parsed = Papa.parse(text, { header:true, dynamicTyping:true });
        return csvToGeoJSON(parsed.data);
      } else {
        const json = JSON.parse(text);
        return json.type === "FeatureCollection" ? json : { type:"FeatureCollection", features: json.features ?? [] };
      }
    }

    function setDataAndRefresh(fc){
      rawData = fc;
      applyFilters();
      refreshLayer();
      fitTo(filtered, 100);
    }

    function buildHexLayer(){
      return new deck.HexagonLayer({
        id: "jobs-hex",
        data: filtered.features,
        getPosition: d => d.geometry.coordinates,
        radius: 5000,          // ~5km cells; tune for NL/EU
        extruded: false,
        colorRange: CONFIG.PALETTE.map(h => [...hexToRgb(h), 220]),
        getColorWeight: d => Number(d.properties[activeAttr]) || 1,
        colorAggregation: "SUM",
        pickable: true,
        onHover: ({x,y,object})=>{
          const t = document.getElementById("tooltip");
          if(object){
            t.style.display="block"; t.style.left=x+"px"; t.style.top=y+"px";
            t.innerHTML = `<div class="font-semibold">Jobs in cell: ${object.points.length}</div>`;
          } else t.style.display="none";
        }
      });
    }

    function filterForEO(){
      // very light keyword filter on role name/company (tweak as you like)
      const kws = ["earth", "observation", "remote", "sensing", "gis", "copernicus", "sentinel"];
      const f = rawData.features.filter(f => {
        const s = `${f.properties.name} ${f.properties.company}`.toLowerCase();
        return kws.some(k => s.includes(k));
      });
      return { type:"FeatureCollection", features: f };
    }

    function setActivePill(activeId){
      ["tabMap","tabEO","tabVE"].forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        el.classList.toggle("bg-accent", id===activeId);
        el.classList.toggle("text-white", id===activeId);
      });
    }

    document.getElementById("tabMap")?.addEventListener("click", ()=>{
      setActivePill("tabMap");
      applyFilters(); // back to normal filtered points
      refreshLayer();
    });

    document.getElementById("tabEO")?.addEventListener("click", ()=>{
      setActivePill("tabEO");
      // scope filtered data to EO-like roles
      const eoData = filterForEO();
      filtered = eoData;
      refreshLayer();
      // also prefill LinkedIn keywords to EO terms
      document.getElementById("liKeywords").value = "earth observation, remote sensing, GIS, Copernicus, Sentinel";
      updateLinkedInPreview();
      fitTo(filtered, 80);
    });

    document.getElementById("tabVE")?.addEventListener("click", ()=>{
      setActivePill("tabVE");
      // keep the same filtered set but switch to hex aggregation
      recomputeColoring(); // keep palette/legend
      deckOverlay.setProps({ layers:[buildHexLayer()] });
    });

    document.getElementById("fileInput")?.addEventListener("change", (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          let fc;
          if (file.name.toLowerCase().endsWith(".csv")) {
            const parsed = Papa.parse(reader.result, { header:true, dynamicTyping:true });
            fc = csvToGeoJSON(parsed.data);
          } else {
            const json = JSON.parse(reader.result);
            fc = json.type === "FeatureCollection" ? json : { type:"FeatureCollection", features: json.features ?? [] };
          }
          setDataAndRefresh(fc);
        } catch(err){ alert("Failed to load file: " + err.message); }
      };
      reader.readAsText(file);
    });

    document.getElementById("loadUrlBtn")?.addEventListener("click", async ()=>{
      const url = document.getElementById("urlInput").value.trim();
      if(!url) return;
      try{
        const fc = await loadGeoDataFromUrl(url);
        setDataAndRefresh(fc);
      }catch(err){ alert("Failed to fetch URL: " + err.message); }
    });

    // Initialize with Netherlands view by default
    map.on("load", ()=>{
      rawData = generateSampleData();
      applyFilters();
      refreshLayer();
      fitTo(filtered, 100);
      updateLinkedInPreview();
    });

    feather.replace();
  </script>
</body>
</html>

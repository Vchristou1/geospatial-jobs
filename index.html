<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Geospatial Jobs Visualization</title>

  <!-- UI / libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"/>
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/deck.gl@8.9.27/dist.min.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>

  <style>
    :root { --bg:#0F1115; --panel:#131722; --stroke:#242634; --text:#E7E9EE; --muted:#9AA0AB; --accent:#5563FF; }
    html,body { height:100%; }
    body { margin:0; background:var(--bg); color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; overflow:hidden; }
    #map { position:absolute; inset:0; }
    .bg-panel{ background:var(--panel); } .text-muted{ color:var(--muted); } .border-stroke{ border-color:var(--stroke); } .bg-accent{ background:var(--accent); }
    .outline-focus:focus{ outline:2px solid var(--accent); outline-offset:2px; }
    .sidebar{ position:absolute; inset:0 auto 0 0; width:340px; z-index:10; box-shadow:2px 0 12px rgba(0,0,0,.35); }
    .legend { display:flex; height:16px; border-radius:6px; overflow:hidden; border:1px solid var(--stroke); }
    .tooltip { position:absolute; z-index:50; pointer-events:none; background:var(--panel); border:1px solid var(--stroke); border-radius:10px; padding:10px; font-size:13px; max-width:280px; transform:translate(10px,-10px); }
    .region-btn{ background:var(--panel); border:1px solid var(--stroke); color:var(--muted); padding:6px 12px; border-radius:8px; cursor:pointer; font-size:13px; }
    .region-btn.active{ background:var(--accent); color:white; }
    .pill{ padding:.35rem .6rem; border:1px solid var(--stroke); border-radius:.6rem; font-size:.75rem; color:var(--muted); cursor:pointer; }
    .pill.active{ background:var(--accent); color:#fff; border-color:transparent; }
    input[type="file"]{ display:none; }

    /* bottom data table drawer */
    .data-drawer{ position:fixed; left:0; right:0; bottom:0; height:40vh; background:var(--panel); border-top:1px solid var(--stroke); transform:translateY(100%); transition:transform .25s ease; z-index:40; display:flex; flex-direction:column; }
    .data-drawer.open{ transform:translateY(0); }
    .drawer-header{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.5rem .75rem; border-bottom:1px solid var(--stroke); }
    .drawer-body{ overflow:auto; height:100%; }
    table.data{ width:100%; border-collapse:collapse; font-size:12px; }
    table.data thead th{ position:sticky; top:0; background:#0F1115; border-bottom:1px solid var(--stroke); text-align:left; padding:.5rem .6rem; cursor:pointer; }
    table.data tbody td{ border-bottom:1px solid var(--stroke); padding:.45rem .6rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .toolbar{ display:flex; align-items:center; gap:.5rem; }
    .btn{ background:var(--panel); border:1px solid var(--stroke); padding:.35rem .6rem; border-radius:.5rem; font-size:.8rem; cursor:pointer; color:var(--text); }
    .btn.primary{ background:var(--accent); border-color:transparent; color:white; }
    .muted{ color:var(--muted); }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar bg-panel flex flex-col">
    <header class="p-4 border-b border-stroke">
      <h1 class="text-xl font-semibold">Geospatial</h1>
      <div class="flex gap-2 mt-3 text-xs">
        <button id="tabMap" class="pill active">Map Visualization</button>
        <button id="tabEO"  class="pill">Earth Observation jobs</button>
        <button id="tabVE"  class="pill">Vector Enrichment jobs</button>
      </div>
    </header>

    <div class="p-4 overflow-y-auto grow space-y-4">
      <!-- Layers -->
      <section class="bg-panel border border-stroke rounded-2xl p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-semibold">Layers</h2>
          <button id="btnAddLayer" class="bg-accent text-white text-sm px-3 py-1 rounded-md">Add Layer</button>
          <input id="fileInput" type="file" accept=".geojson,.json,.csv"/>
        </div>

        <div class="border border-stroke rounded-xl p-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <input id="layerVisible" type="checkbox" checked class="accent-indigo-500"/>
              <span>Job layer</span>
            </div>
            <span id="layerModeLabel" class="text-muted text-xs">Clusters / Points</span>
          </div>

          <div class="mt-3 grid grid-cols-1 gap-3">
            <div>
              <label class="text-sm text-muted">Color based on</label>
              <select id="attrSelect" class="mt-1 w-full bg-panel border border-stroke rounded-md px-3 py-2 outline-focus">
                <option value="count">count</option>
                <option value="salary">salary</option>
                <option value="experience">experience</option>
              </select>
            </div>

            <div>
              <label class="text-sm text-muted">Classification</label>
              <select id="classSelect" class="mt-1 w-full bg-panel border border-stroke rounded-md px-3 py-2 outline-focus">
                <option value="quantile">Quantile (Q5)</option>
                <option value="equal">Equal Interval</option>
              </select>
            </div>

            <div>
              <div class="legend" id="legendRamp"></div>
              <div id="legendLabels" class="flex justify-between text-[11px] text-muted mt-1"><span>low</span><span>high</span></div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-muted">Radius</label>
                <input id="radiusRange" type="range" min="3" max="12" value="6" class="w-full"/>
              </div>
              <div>
                <label class="text-sm text-muted">Opacity</label>
                <input id="opacityRange" type="range" min="30" max="100" value="75" class="w-full"/>
              </div>
            </div>

            <label class="inline-flex items-center gap-2 text-sm">
              <input id="blendToggle" type="checkbox" checked class="accent-indigo-500"/>
              <span class="text-muted">Additive blending (glow)</span>
            </label>
          </div>
        </div>
      </section>

      <!-- Paste data -->
      <section class="bg-panel border border-stroke rounded-2xl p-4">
        <h2 class="font-semibold mb-2">Paste Job Data</h2>
        <p class="text-muted text-sm mb-3">Paste CSV/TSV from Excel/Sheets. Use columns like: <code>title</code>, <code>company</code>, <code>country</code>, <code>salary</code>, <code>experience</code>, and either <code>lat/lon</code> or a <code>location</code> text.</p>

        <textarea id="jobDataInput" class="w-full h-32 bg-panel border border-stroke rounded-md px-3 py-2 outline-focus"
          placeholder="Example:
title,company,location,country,salary,experience
SAP Consultant,Acme,'Amsterdam, Netherlands',NL,78000,3"></textarea>

        <div class="grid grid-cols-2 gap-3 mt-3 mb-3">
          <div>
            <label class="text-sm text-muted">Location column</label>
            <select id="locationColumn" class="mt-1 w-full bg-panel border border-stroke rounded-md px-3 py-2 outline-focus">
              <option value="location">location</option>
              <option value="city">city</option>
              <option value="address">address</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-muted">Title column</label>
            <select id="titleColumn" class="mt-1 w-full bg-panel border border-stroke rounded-md px-3 py-2 outline-focus">
              <option value="title">title</option>
              <option value="job_title">job_title</option>
              <option value="role">role</option>
            </select>
          </div>
        </div>

        <div class="flex gap-2">
          <button id="visualizeJobsBtn" class="bg-accent text-white w-full py-2 rounded-md">Visualize on Map</button>
          <button id="toggleTableBtn" type="button" class="w-40 py-2 rounded-md btn">Toggle Table</button>
        </div>
      </section>

      <!-- Filters -->
      <section class="bg-panel border border-stroke rounded-2xl p-4">
        <h2 class="font-semibold mb-2">Filters</h2>
        <div class="grid grid-cols-1 gap-3">
          <select id="countryFilter" class="bg-panel border border-stroke rounded-md px-3 py-2">
            <option value="">All countries</option>
            <option value="NL">Netherlands</option>
            <option value="DE">Germany</option>
            <option value="FR">France</option>
            <option value="BE">Belgium</option>
            <option value="UK">United Kingdom</option>
          </select>
          <input id="searchFilter" class="bg-panel border border-stroke rounded-md px-3 py-2" placeholder="Filter by company or job"/>
        </div>
      </section>
    </div>
  </aside>

  <!-- Region buttons -->
  <div class="absolute top-4 left-[360px] z-10 flex gap-2">
    <button class="region-btn active" data-region="fit">Fit to Data</button>
    <button class="region-btn" data-region="europe">Europe</button>
    <button class="region-btn" data-region="nl">Netherlands</button>
  </div>

  <!-- Map + tooltip -->
  <div id="map"></div>
  <div id="tooltip" class="tooltip" style="display:none;"></div>

  <!-- DATA TABLE DRAWER -->
  <div id="dataDrawer" class="data-drawer" aria-hidden="true">
    <div class="drawer-header">
      <div class="toolbar">
        <strong>Data table</strong>
        <label class="text-xs flex items-center gap-1 ml-3">
          <input id="tableFilteredToggle" type="checkbox" class="accent-indigo-500" checked/>
          <span class="muted">Use current filters</span>
        </label>
        <span id="tableCount" class="muted text-xs"></span>
      </div>
      <div class="toolbar">
        <label class="text-xs muted">Rows / page</label>
        <select id="rowsPerPage" class="bg-panel border border-stroke rounded px-2 py-1 text-xs">
          <option>50</option><option selected>100</option><option>500</option>
        </select>
        <button id="prevPage" class="btn">Prev</button>
        <span id="pageInfo" class="muted text-xs">1 / 1</span>
        <button id="nextPage" class="btn">Next</button>
        <button id="exportCsv" class="btn">Export CSV</button>
        <button id="closeDrawer" class="btn">Close</button>
      </div>
    </div>
    <div class="drawer-body">
      <table class="data" id="dataTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const CONFIG = {
      STYLE_URL: "https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",
      PALETTE: ["#6C1D6B","#9C2C7A","#D4475D","#F07E2E","#FFA600"],
      ATTR_DEFAULT: "count",
      CLUSTER_RADIUS: 60,           // px
      CLUSTER_MAX_ZOOM: 14          // stop clustering after this zoom
    };

    // ---------- utils ----------
    const hexToRgb = h => { const m=h.replace("#",""); return [parseInt(m.slice(0,2),16),parseInt(m.slice(2,4),16),parseInt(m.slice(4,6),16)]; };
    const quantiles = (arr,k)=>{ const a=[...arr].sort((x,y)=>x-y),q=[]; for(let i=1;i<k;i++){ const p=i/k,idx=(a.length-1)*p,lo=Math.floor(idx),hi=Math.ceil(idx); q.push(lo===hi?a[lo]:a[lo]+(a[hi]-a[lo])*(idx-lo)); } return q; };
    const equalBreaks=(arr,k)=>{ const min=Math.min(...arr),max=Math.max(...arr),step=(max-min)/k,b=[]; for(let i=1;i<k;i++) b.push(min+step*i); return b; };
    const classify=(v,br)=>{ for(let i=0;i<br.length;i++) if(v<=br[i]) return i; return br.length; };
    const fmt=n=> new Intl.NumberFormat().format(n);

    // ---------- map ----------
    const map = new maplibregl.Map({ container:"map", style: CONFIG.STYLE_URL, center:[5.3,52.2], zoom:6.2, attributionControl:true });
    const deckOverlay = new deck.MapboxOverlay({ interleaved:true, layers:[] });
    map.addControl(deckOverlay);

    // ---------- state ----------
    let rawData=null, filtered=null, breaks=null, activeAttr=CONFIG.ATTR_DEFAULT;
    let currentMode = "map"; // 'map' | 'eo' | 've'
    const layerModeLabel = document.getElementById("layerModeLabel");

    // ---------- sample data ----------
    function generateSampleData(){
      const jobLocations = [
        { city: "Amsterdam", company: "Leaseweb", lat: 52.3667, lon: 4.8945, job: "SAP Functional Application Manager" },
        { city: "Amsterdam", company: "Deloitte",  lat: 52.3667, lon: 4.8945, job: "Junior SAP Consultant" },
        { city: "Lieshout",  company: "Royal Swinkels", lat: 51.5194, lon: 5.5958, job: "Junior SAP Application Manager" },
        { city: "Utrecht",   company: "Billennium", lat: 52.0907, lon: 5.1214, job: "SAP Consultant (Remote)" },
        { city: "Eindhoven", company: "SixteenFifty", lat: 51.4416, lon: 5.4697, job: "SAP MM Support Consultant" }
      ];
      return { type:"FeatureCollection", features: jobLocations.map((loc,i)=>({
        type:"Feature",
        geometry:{ type:"Point", coordinates:[loc.lon,loc.lat] },
        properties:{ id:i, name:loc.job, company:loc.company, country:"NL", count:1, salary: 60000+((Math.random()*30000)|0), experience: 2+((Math.random()*3)|0) }
      }))};
    }

    // ---------- Deck.gl layers for VE ----------
    function buildHexLayer(){
      return new deck.HexagonLayer({
        id:"jobs-hex",
        data: filtered.features,
        getPosition:d=>d.geometry.coordinates,
        radius:5000, extruded:false,
        colorRange: CONFIG.PALETTE.map(h=>[...hexToRgb(h),220]),
        getColorWeight:d=>Number(d.properties[activeAttr])||1,
        colorAggregation:"SUM",
        pickable:true,
        onHover: ({x,y,object})=>{
          const t=document.getElementById("tooltip");
          if(object){ t.style.display="block"; t.style.left=x+"px"; t.style.top=y+"px"; t.innerHTML=`<div class="font-semibold">Jobs in cell: ${object.points.length}</div>`; }
          else t.style.display="none";
        }
      });
    }

    // ---------- clustering layers for Map/EO ----------
    const CLUSTER_SOURCE = "jobs-cluster-src";
    const L_CLUSTER_CIRCLES = "jobs-cluster-circles";
    const L_CLUSTER_COUNT   = "jobs-cluster-count";
    const L_UNCLUSTERED     = "jobs-unclustered";

    function ensureClusterLayers(){
      if(map.getSource(CLUSTER_SOURCE)) return;

      map.addSource(CLUSTER_SOURCE, {
        type: "geojson",
        data: {type:"FeatureCollection", features:[]},
        cluster: true,
        clusterRadius: CONFIG.CLUSTER_RADIUS,
        clusterMaxZoom: CONFIG.CLUSTER_MAX_ZOOM
      });

      // color thresholds similar to your screenshot
      const colorByCount = [
        "step", ["get","point_count"],
        "#2b7bff",     // 0-9
        10, "#3aa0ff", // 10-29
        30, "#ffd166", // 30-69
        70, "#ff8c42", // 70-99
        100, "#ff4d4d" // 100+
      ];
      const radiusByCount = [
        "step", ["get","point_count"],
        14,      // <=9
        10, 18,  // <=29
        30, 22,  // <=69
        70, 28,  // <=99
        100, 34  // 100+
      ];

      map.addLayer({
        id: L_CLUSTER_CIRCLES,
        type: "circle",
        source: CLUSTER_SOURCE,
        filter: ["has","point_count"],
        paint: {
          "circle-color": colorByCount,
          "circle-radius": radiusByCount,
          "circle-opacity": 0.9,
          "circle-stroke-color": "#0F1115",
          "circle-stroke-width": 2
        }
      });

      map.addLayer({
        id: L_CLUSTER_COUNT,
        type: "symbol",
        source: CLUSTER_SOURCE,
        filter: ["has","point_count"],
        layout: {
          "text-field": ["get","point_count"],
          "text-size": 12
        },
        paint: { "text-color": "#ffffff" }
      });

      map.addLayer({
        id: L_UNCLUSTERED,
        type: "circle",
        source: CLUSTER_SOURCE,
        filter: ["!", ["has", "point_count"]],
        paint: {
          "circle-color": "#ffa600",
          "circle-radius": 6,
          "circle-opacity": 0.85,
          "circle-stroke-color": "#0F1115",
          "circle-stroke-width": 1.5
        }
      });

      // click cluster → zoom in
      map.on("click", L_CLUSTER_CIRCLES, e=>{
        const feature = e.features?.[0];
        if(!feature) return;
        const src = map.getSource(CLUSTER_SOURCE);
        src.getClusterExpansionZoom(feature.properties.cluster_id, (err, zoom)=>{
          if(err) return;
          map.easeTo({ center: feature.geometry.coordinates, zoom });
        });
      });

      // click unclustered → fly to point
      map.on("click", L_UNCLUSTERED, e=>{
        const f=e.features?.[0]; if(!f) return;
        map.flyTo({ center: f.geometry.coordinates, zoom: 10, essential: true });
      });

      map.on("mouseenter", L_CLUSTER_CIRCLES, ()=> map.getCanvas().style.cursor="pointer");
      map.on("mouseleave", L_CLUSTER_CIRCLES, ()=> map.getCanvas().style.cursor="");
      map.on("mouseenter", L_UNCLUSTERED, ()=> map.getCanvas().style.cursor="pointer");
      map.on("mouseleave", L_UNCLUSTERED, ()=> map.getCanvas().style.cursor="");
    }

    function updateClusterData(fc){
      ensureClusterLayers();
      const src = map.getSource(CLUSTER_SOURCE);
      if(src) src.setData(fc);
    }

    function showClusterLayers(show){
      [L_CLUSTER_CIRCLES, L_CLUSTER_COUNT, L_UNCLUSTERED].forEach(id=>{
        if(map.getLayer(id)) map.setLayoutProperty(id, "visibility", show ? "visible" : "none");
      });
    }

    // ---------- classification / filters / table ----------
    function recomputeColoring(){
      const vals = filtered.features.map(f=>Number(f.properties[activeAttr])).filter(Number.isFinite);
      if(vals.length===0){ breaks=[0,0,0,0]; return; }
      const method = document.getElementById("classSelect").value;
      breaks = method==="equal" ? equalBreaks(vals, CONFIG.PALETTE.length) : quantiles(vals, CONFIG.PALETTE.length);
      document.getElementById("legendRamp").innerHTML = CONFIG.PALETTE.map(c=>`<div style="flex:1;background:${c}"></div>`).join("");
      const labs=[Math.min(...vals),...breaks,Math.max(...vals)];
      document.getElementById("legendLabels").innerHTML = `<span>${fmt(Math.round(labs[0]))}</span><span>${fmt(Math.round(labs.at(-1)))}</span>`;
    }

    function applyFilters(){
      if(!rawData){ filtered={type:"FeatureCollection", features:[]}; return; }
      const iso=document.getElementById("countryFilter").value;
      const q =(document.getElementById("searchFilter").value||"").trim().toLowerCase();
      filtered = { type:"FeatureCollection", features: rawData.features.filter(f=>{
        const ok=!iso || f.properties.country===iso;
        const txt=`${f.properties.name} ${f.properties.company}`.toLowerCase();
        return ok && (!q || txt.includes(q));
      })};
    }

    // table drawer state
    const drawer = document.getElementById("dataDrawer");
    const toggleTableBtn = document.getElementById("toggleTableBtn");
    const closeDrawer = document.getElementById("closeDrawer");
    const tableHead = document.getElementById("tableHead");
    const tableBody = document.getElementById("tableBody");
    const tableFilteredToggle = document.getElementById("tableFilteredToggle");
    const rowsPerPageSel = document.getElementById("rowsPerPage");
    const pageInfo = document.getElementById("pageInfo");
    const tableCount = document.getElementById("tableCount");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const exportCsvBtn = document.getElementById("exportCsv");

    const COLUMNS = [
      {key:"id", label:"ID"},
      {key:"name", label:"Title"},
      {key:"company", label:"Company"},
      {key:"country", label:"Country"},
      {key:"count", label:"Count"},
      {key:"salary", label:"Salary"},
      {key:"experience", label:"Exp"},
      {key:"lat", label:"Lat"},
      {key:"lon", label:"Lon"}
    ];
    let sortKey="name", sortAsc=true, page=1;

    function toggleDrawer(open){ drawer.classList.toggle("open", open ?? !drawer.classList.contains("open")); drawer.setAttribute("aria-hidden", drawer.classList.contains("open")?"false":"true"); }
    function currentFeatureList(){ return (tableFilteredToggle.checked ? (filtered?.features||[]) : (rawData?.features||[])); }
    function rowsFromFeatures(features){ return features.map(f=>({ id:f.properties.id, name:f.properties.name, company:f.properties.company, country:f.properties.country, count:+(f.properties.count||0), salary:+(f.properties.salary||0), experience:+(f.properties.experience||0), lat:+f.geometry.coordinates[1], lon:+f.geometry.coordinates[0], _coords:f.geometry.coordinates })); }

    function updateTable(){
      const size = Number(rowsPerPageSel.value||100);
      let rows = rowsFromFeatures(currentFeatureList());
      rows.sort((a,b)=>{ const va=a[sortKey], vb=b[sortKey]; if(va==null && vb==null) return 0; if(va==null) return 1; if(vb==null) return -1; if(typeof va==="number"&&typeof vb==="number") return sortAsc?va-vb:vb-va; return (sortAsc?1:-1)*String(va).localeCompare(String(vb)); });
      const total = rows.length; const totalPages=Math.max(1,Math.ceil(total/size)); if(page>totalPages) page=totalPages;
      const start=(page-1)*size, end=start+size, pageRows=rows.slice(start,end);
      tableHead.innerHTML = "<tr>"+COLUMNS.map(c=>`<th data-key="${c.key}">${c.label}${sortKey===c.key?(sortAsc?" ▲":" ▼"):""}</th>`).join("")+"</tr>";
      tableBody.innerHTML = pageRows.map(r=>`<tr class="hover:bg-black/20 cursor-pointer" data-center="${r._coords}">
          <td>${r.id??""}</td><td title="${r.name??""}">${r.name??""}</td><td title="${r.company??""}">${r.company??""}</td>
          <td>${r.country??""}</td><td>${r.count??""}</td><td>${r.salary? "€"+fmt(r.salary):""}</td><td>${r.experience??""}</td>
          <td>${r.lat?.toFixed?.(4)??""}</td><td>${r.lon?.toFixed?.(4)??""}</td></tr>`).join("");
      pageInfo.textContent = `${page} / ${totalPages}`; tableCount.textContent = `(${fmt(total)} rows)`;
      [...tableHead.querySelectorAll("th")].forEach(th=> th.onclick=()=>{ const k=th.dataset.key; if(k===sortKey) sortAsc=!sortAsc; else {sortKey=k; sortAsc=true;} updateTable(); });
      [...tableBody.querySelectorAll("tr")].forEach(tr=> tr.onclick=()=>{ const center=tr.getAttribute("data-center").split(",").map(Number); if(center.length===2) map.flyTo({ center, zoom:10, essential:true }); });
    }
    prevPageBtn.onclick = ()=>{ page=Math.max(1,page-1); updateTable(); };
    nextPageBtn.onclick = ()=>{ page=page+1; updateTable(); };
    rowsPerPageSel.onchange = ()=>{ page=1; updateTable(); };
    tableFilteredToggle.onchange = ()=>{ page=1; updateTable(); };
    exportCsvBtn.onclick = ()=>{
      const rows = rowsFromFeatures(currentFeatureList());
      const header = COLUMNS.map(c=>c.label).join(",");
      const csv = [header, ...rows.map(r => [r.id,r.name,r.company,r.country,r.count,r.salary,r.experience,r.lat,r.lon].map(v=>{
        if(v==null) return ""; const s=String(v).replace(/"/g,'""'); return /[",\n]/.test(s)?`"${s}"`:s;
      }).join(","))].join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="jobs.csv"; a.click(); URL.revokeObjectURL(url);
    };
    document.getElementById("toggleTableBtn").onclick = ()=> toggleDrawer();
    document.getElementById("closeDrawer").onclick = ()=> toggleDrawer(false);
    window.addEventListener("keydown", (e)=>{ if(e.key.toLowerCase()==="t") toggleDrawer(); if(e.key==="Escape") toggleDrawer(false); });

    // ---------- mode switching ----------
    function setMode(mode){
      currentMode = mode;
      ["tabMap","tabEO","tabVE"].forEach(id=> document.getElementById(id).classList.toggle("active", id === ("tab"+mode[0].toUpperCase()+mode.slice(1)) ));
      if(mode==="ve"){
        // hex aggregation
        layerModeLabel.textContent = "Hex aggregation";
        showClusterLayers(false);
        recomputeColoring();
        deckOverlay.setProps({ layers:[buildHexLayer()] });
      } else {
        // clustered points (map / eo)
        layerModeLabel.textContent = "Clusters / Points";
        deckOverlay.setProps({ layers:[] });
        updateClusterData(filtered);
        showClusterLayers(true);
      }
      updateTable();
    }

    // ---------- map helpers ----------
    function fitTo(fc,pad=100){ const b=turf.bbox(fc); map.fitBounds([[b[0],b[1]],[b[2],b[3]]],{padding:pad,duration:800}); }
    function flyRegion(tag){ if(tag==="europe") map.fitBounds([[-25,35],[45,72]],{padding:50}); else if(tag==="nl") map.fitBounds([[3.2,50.5],[7.3,53.7]],{padding:60}); else if(filtered?.features?.length) fitTo(filtered); }

    // ---------- data -> GeoJSON from CSV ----------
    function csvToGeoJSON(rows){
      const header = Object.keys(rows[0]||{}).reduce((m,k)=>{ m[k.toLowerCase()]=k; return m; },{});
      const lonK=header.longitude||header.lon||header.lng||header.x;
      const latK=header.latitude||header.lat||header.y;
      const features=[];
      for(let i=0;i<rows.length;i++){
        const r=rows[i], lon=Number(r[lonK]), lat=Number(r[latK]);
        if(Number.isFinite(lon) && Number.isFinite(lat)){
          features.push({ type:"Feature", geometry:{type:"Point",coordinates:[lon,lat]}, properties:{ id:r.id ?? i, name:r.title ?? r.job_title ?? r.role ?? r.name ?? "Job", company:r.company ?? r.employer ?? "", country:r.country ?? "", count: Number(r.count ?? 1) || 1, salary: Number(r.salary ?? r.pay ?? 0) || 0, experience: Number(r.experience ?? r.exp ?? 0) || 0 } });
        }
      }
      return { type:"FeatureCollection", features };
    }

    async function geocode(text){
      const url=`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(text)}&limit=1`;
      const res=await fetch(url,{headers:{'Accept':'application/json'}});
      const j=await res.json();
      if(!Array.isArray(j) || j.length===0) return null;
      return [parseFloat(j[0].lon), parseFloat(j[0].lat)];
    }

    // ---------- UI listeners ----------
    document.getElementById("tabMap").addEventListener("click", ()=>{ applyFilters(); setMode("map"); if(filtered.features.length) fitTo(filtered,90); });
    document.getElementById("tabEO").addEventListener("click", ()=>{
      const kws=["earth","observation","remote","sensing","gis","copernicus","sentinel"];
      const base = rawData?.features || [];
      filtered = { type:"FeatureCollection", features: base.filter(f=>{ const s=`${f.properties.name} ${f.properties.company}`.toLowerCase(); return kws.some(k=>s.includes(k)); }) };
      setMode("eo"); if(filtered.features.length) fitTo(filtered,90);
    });
    document.getElementById("tabVE").addEventListener("click", ()=>{ applyFilters(); setMode("ve"); if(filtered.features.length) fitTo(filtered,90); });

    document.getElementById("btnAddLayer").addEventListener("click", ()=> document.getElementById("fileInput").click());
    document.getElementById("fileInput").addEventListener("change", (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=()=>{ try{
        let fc;
        if(f.name.toLowerCase().endsWith(".csv")){
          const parsed=Papa.parse(reader.result,{header:true, dynamicTyping:true, skipEmptyLines:true});
          fc=csvToGeoJSON(parsed.data);
        }else{
          const json=JSON.parse(reader.result);
          fc=json.type==="FeatureCollection"?json:{type:"FeatureCollection",features:json.features??[]};
        }
        rawData=fc; applyFilters();
        // update both possible renderers
        updateClusterData(filtered);
        if(currentMode==="ve") deckOverlay.setProps({ layers:[buildHexLayer()] });
        setMode(currentMode);
        if(filtered.features.length) fitTo(filtered,100);
      }catch(err){ alert("Failed to load file: "+err.message); } };
      reader.readAsText(f);
    });

    document.getElementById("visualizeJobsBtn").addEventListener("click", async ()=>{
      const text=(document.getElementById("jobDataInput").value||"").trim();
      if(!text){ alert("Paste some rows first."); return; }
      const parsed=Papa.parse(text,{header:true, dynamicTyping:true, skipEmptyLines:true});
      let fc=csvToGeoJSON(parsed.data);
      if(fc.features.length===0){
        const locKey=document.getElementById("locationColumn").value;
        const titleKey=document.getElementById("titleColumn").value;
        const cache=new Map(); const feats=[];
        for(const row of parsed.data){
          const loc=row[locKey]; const title=row[titleKey];
          if(!loc || !title) continue;
          let coords=cache.get(loc); if(!coords){ try{ coords=await geocode(loc); cache.set(loc,coords); }catch(e){ coords=null; } }
          if(coords){ feats.push({ type:"Feature", geometry:{type:"Point",coordinates:coords}, properties:{ id:feats.length, name:title, company: row.company ?? row.employer ?? "", country: row.country ?? "", count:1, salary: Number(row.salary)||0, experience: Number(row.experience)||0 } }); }
        }
        fc={type:"FeatureCollection",features:feats};
      }
      if(fc.features.length===0){ alert("No mappable rows found."); return; }
      rawData=fc; applyFilters();
      updateClusterData(filtered);
      setMode(currentMode); // refresh renderer + table
      fitTo(filtered,100);
    });

    document.getElementById("layerVisible").addEventListener("change",(e)=>{
      const on = e.target.checked;
      if(currentMode==="ve"){ deckOverlay.setProps({ layers: on ? [buildHexLayer()] : [] }); }
      else { showClusterLayers(on); }
    });

    ["attrSelect","classSelect","radiusRange","opacityRange","blendToggle"].forEach(id=>{
      document.getElementById(id).addEventListener("change", ()=>{ if(currentMode==="ve"){ deckOverlay.setProps({ layers:[buildHexLayer()] }); } updateTable(); });
      document.getElementById(id).addEventListener("input",  ()=>{ if(currentMode==="ve"){ deckOverlay.setProps({ layers:[buildHexLayer()] }); } });
    });

    document.getElementById("countryFilter").addEventListener("change", ()=>{ applyFilters(); updateClusterData(filtered); setMode(currentMode); if(filtered.features.length) fitTo(filtered,80); });
    document.getElementById("searchFilter").addEventListener("input", ()=>{ applyFilters(); updateClusterData(filtered); setMode(currentMode); });

    document.querySelectorAll(".region-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{ document.querySelectorAll(".region-btn").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); flyRegion(btn.dataset.region); });
    });

    // ---------- init ----------
    map.on("load", ()=>{
      ensureClusterLayers();
      rawData = generateSampleData();
      applyFilters();
      updateClusterData(filtered);
      setMode("map");
      if(filtered.features.length) fitTo(filtered,100);
      updateTable();
    });

    feather.replace();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Geospatial Jobs Visualization</title>

  <!-- UI / libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"/>
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/deck.gl@8.9.27/dist.min.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>

  <style>
    :root { --bg:#0F1115; --panel:#131722; --stroke:#242634; --text:#E7E9EE; --muted:#9AA0AB; --accent:#5563FF; }
    html,body { height:100%; }
    body { margin:0; background:var(--bg); color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; overflow:hidden; }
    #map { position:absolute; inset:0; }
    .bg-panel{ background:var(--panel); } .text-muted{ color:var(--muted); } .border-stroke{ border-color:var(--stroke); } .bg-accent{ background:var(--accent); }
    .outline-focus:focus{ outline:2px solid var(--accent); outline-offset:2px; }
    .sidebar{ position:absolute; inset:0 auto 0 0; width:360px; z-index:10; box-shadow:2px 0 12px rgba(0,0,0,.35); }
    .legend { display:flex; height:16px; border-radius:6px; overflow:hidden; border:1px solid var(--stroke); }
    .tooltip { position:absolute; z-index:50; pointer-events:none; background:var(--panel); border:1px solid var(--stroke); border-radius:10px; padding:10px; font-size:13px; max-width:280px; transform:translate(10px,-10px); }
    .region-btn{ background:var(--panel); border:1px solid var(--stroke); color:var(--muted); padding:6px 12px; border-radius:8px; cursor:pointer; font-size:13px; }
    .region-btn.active{ background:var(--accent); color:white; }
    .pill{ padding:.35rem .6rem; border:1px solid var(--stroke); border-radius:.6rem; font-size:.75rem; color:var(--muted); cursor:pointer; }
    .pill.active{ background:var(--accent); color:#fff; border-color:transparent; }
    input[type="file"]{ display:none; }

    /* bottom data table drawer */
    .data-drawer{ position:fixed; left:0; right:0; bottom:0; height:42vh; background:var(--panel); border-top:1px solid var(--stroke); transform:translateY(100%); transition:transform .25s ease; z-index:40; display:flex; flex-direction:column; }
    .data-drawer.open{ transform:translateY(0); }
    .drawer-header{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.5rem .75rem; border-bottom:1px solid var(--stroke); }
    .drawer-body{ overflow:auto; height:100%; }
    table.data{ width:100%; border-collapse:collapse; font-size:12px; }
    table.data thead th{ position:sticky; top:0; background:#0F1115; border-bottom:1px solid var(--stroke); text-align:left; padding:.5rem .6rem; cursor:pointer; }
    table.data tbody td{ border-bottom:1px solid var(--stroke); padding:.4rem .6rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    table.data td[contenteditable="true"]{ outline:1px dashed transparent; }
    table.data td[contenteditable="true"]:focus{ outline:1px dashed var(--accent); background:#0c0f18; }
    .toolbar{ display:flex; align-items:center; gap:.5rem; }
    .btn{ background:var(--panel); border:1px solid var(--stroke); padding:.35rem .6rem; border-radius:.5rem; font-size:.8rem; cursor:pointer; color:var(--text); }
    .btn.primary{ background:var(--accent); border-color:transparent; color:white; }
    .muted{ color:var(--muted); }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar bg-panel flex flex-col">
    <header class="p-4 border-b border-stroke">
      <h1 class="text-xl font-semibold">Geospatial</h1>
      <div class="flex gap-2 mt-3 text-xs">
        <button id="tabMap" class="pill active">Map Visualization</button>
        <button id="tabEO"  class="pill">Earth Observation jobs</button>
        <button id="tabVE"  class="pill">Vector Enrichment jobs</button>
      </div>
    </header>

    <div class="p-4 overflow-y-auto grow space-y-4">
      <!-- Layers -->
      <section class="bg-panel border border-stroke rounded-2xl p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-semibold">Layers</h2>
          <button id="btnAddLayer" class="bg-accent text-white text-sm px-3 py-1 rounded-md">Add Layer</button>
          <input id="fileInput" type="file" accept=".geojson,.json,.csv"/>
        </div>

        <div class="border border-stroke rounded-xl p-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <input id="layerVisible" type="checkbox" checked class="accent-indigo-500"/>
              <span>Job layer</span>
            </div>
            <span id="layerModeLabel" class="text-muted text-xs">Clusters / Points</span>
          </div>

          <div class="mt-3 grid grid-cols-1 gap-3">
            <div>
              <label class="text-sm text-muted">Renderer</label>
              <select id="rendererSelect" class="mt-1 w-full bg-panel border border-stroke rounded-md px-3 py-2 outline-focus">
                <option value="clusters" selected>Clusters / Points</option>
                <option value="heatmap">Heatmap</option>
                <option value="hexgrid">Hex grid (Vector enrichment)</option>
              </select>
            </div>

            <div>
              <label class="text-sm text-muted">Color based on</label>
              <select id="attrSelect" class="mt-1 w-full bg-panel border border-stroke rounded-md px-3 py-2 outline-focus">
                <option value="count">count</option>
                <option value="salary">salary</option>
                <option value="experience">experience</option>
              </select>
            </div>

            <div>
              <label class="text-sm text-muted">Classification</label>
              <select id="classSelect" class="mt-1 w-full bg-panel border border-stroke rounded-md px-3 py-2 outline-focus">
                <option value="quantile">Quantile (Q5)</option>
                <option value="equal">Equal Interval</option>
              </select>
            </div>

            <div>
              <div class="legend" id="legendRamp"></div>
              <div id="legendLabels" class="flex justify-between text-[11px] text-muted mt-1"><span>low</span><span>high</span></div>
            </div>

            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-muted">Radius</label>
                <input id="radiusRange" type="range" min="3" max="12" value="6" class="w-full"/>
              </div>
              <div>
                <label class="text-sm text-muted">Opacity</label>
                <input id="opacityRange" type="range" min="30" max="100" value="85" class="w-full"/>
              </div>
            </div>

            <label class="inline-flex items-center gap-2 text-sm">
              <input id="blendToggle" type="checkbox" checked class="accent-indigo-500"/>
              <span class="text-muted">Additive blending (glow)</span>
            </label>
          </div>
        </div>
      </section>

      <!-- Paste data -->
      <section class="bg-panel border border-stroke rounded-2xl p-4">
        <h2 class="font-semibold mb-2">Paste Job Data</h2>
        <p class="text-muted text-sm mb-3">Paste CSV/TSV from Excel/Sheets. Must include <code>lat/lon</code>, or a geocodable <code>location</code>. Optional: <code>title</code>, <code>company</code>, <code>country</code>, <code>salary</code>, <code>experience</code>, <code>type</code>, <code>date</code>.</p>

        <textarea id="jobDataInput" class="w-full h-32 bg-panel border border-stroke rounded-md px-3 py-2 outline-focus"
          placeholder="title,company,location,country,salary,experience,type,date
SAP Consultant,Acme,'Amsterdam, Netherlands',NL,78000,3,Hybrid,2025-03-05"></textarea>

        <div class="grid grid-cols-2 gap-3 mt-3 mb-3">
          <div>
            <label class="text-sm text-muted">Location column</label>
            <select id="locationColumn" class="mt-1 w-full bg-panel border border-stroke rounded-md px-3 py-2 outline-focus">
              <option value="location">location</option>
              <option value="city">city</option>
              <option value="address">address</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-muted">Title column</label>
            <select id="titleColumn" class="mt-1 w-full bg-panel border border-stroke rounded-md px-3 py-2 outline-focus">
              <option value="title">title</option>
              <option value="job_title">job_title</option>
              <option value="role">role</option>
            </select>
          </div>
        </div>

        <div class="flex gap-2">
          <button id="visualizeJobsBtn" class="bg-accent text-white w-full py-2 rounded-md">Visualize on Map</button>
          <button id="toggleTableBtn" type="button" class="w-40 py-2 rounded-md btn">Toggle Table</button>
        </div>
      </section>

      <!-- Filters -->
      <section class="bg-panel border border-stroke rounded-2xl p-4">
        <h2 class="font-semibold mb-2">Filters</h2>
        <div class="grid grid-cols-1 gap-3">
          <select id="countryFilter" class="bg-panel border border-stroke rounded-md px-3 py-2">
            <option value="">All countries</option>
            <option value="NL">Netherlands</option>
            <option value="DE">Germany</option>
            <option value="FR">France</option>
            <option value="BE">Belgium</option>
            <option value="UK">United Kingdom</option>
          </select>
          <input id="searchFilter" class="bg-panel border border-stroke rounded-md px-3 py-2" placeholder="Filter by company or job"/>
        </div>
      </section>
    </div>
  </aside>

  <!-- Region buttons -->
  <div class="absolute top-4 left-[380px] z-10 flex gap-2">
    <button class="region-btn active" data-region="fit">Fit to Data</button>
    <button class="region-btn" data-region="europe">Europe</button>
    <button class="region-btn" data-region="nl">Netherlands</button>
  </div>

  <!-- Map + tooltip -->
  <div id="map"></div>
  <div id="tooltip" class="tooltip" style="display:none;"></div>

  <!-- DATA TABLE DRAWER (editable) -->
  <div id="dataDrawer" class="data-drawer" aria-hidden="true">
    <div class="drawer-header">
      <div class="toolbar">
        <strong>Data table</strong>
        <label class="text-xs flex items-center gap-1 ml-3">
          <input id="tableFilteredToggle" type="checkbox" class="accent-indigo-500" checked/>
          <span class="muted">Use current filters</span>
        </label>
        <span id="tableCount" class="muted text-xs"></span>
      </div>
      <div class="toolbar">
        <label class="text-xs muted">Rows / page</label>
        <select id="rowsPerPage" class="bg-panel border border-stroke rounded px-2 py-1 text-xs">
          <option>50</option><option selected>100</option><option>500</option>
        </select>
        <button id="prevPage" class="btn">Prev</button>
        <span id="pageInfo" class="muted text-xs">1 / 1</span>
        <button id="nextPage" class="btn">Next</button>
        <button id="exportCsv" class="btn">Export CSV</button>
        <button id="closeDrawer" class="btn">Close</button>
      </div>
    </div>
    <div class="drawer-body">
      <table class="data" id="dataTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const CONFIG = {
      STYLE_URL: "https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",
      PALETTE: ["#6C1D6B","#9C2C7A","#D4475D","#F07E2E","#FFA600"],
      ATTR_DEFAULT: "count",
      CLUSTER_RADIUS: 60, CLUSTER_MAX_ZOOM: 14,
      HEX_CELL_KM: 8
    };

    // ---------- utils ----------
    const hexToRgb = h => { const m=h.replace("#",""); return [parseInt(m.slice(0,2),16),parseInt(m.slice(2,4),16),parseInt(m.slice(4,6),16)]; };
    const fmt=n=> new Intl.NumberFormat().format(n);
    const quantiles = (arr,k)=>{ const a=[...arr].sort((x,y)=>x-y),q=[]; for(let i=1;i<k;i++){ const p=i/k,idx=(a.length-1)*p,lo=Math.floor(idx),hi=Math.ceil(idx); q.push(lo===hi?a[lo]:a[lo]+(a[hi]-a[lo])*(idx-lo)); } return q; };
    const equalBreaks=(arr,k)=>{ const min=Math.min(...arr),max=Math.max(...arr),step=(max-min)/k,b=[]; for(let i=1;i<k;i++) b.push(min+step*i); return b; };
    const classify=(v,br)=>{ for(let i=0;i<br.length;i++) if(v<=br[i]) return i; return br.length; };

    // ---------- map ----------
    const map = new maplibregl.Map({ container:"map", style: CONFIG.STYLE_URL, center:[5.3,52.2], zoom:6.2, attributionControl:true });
    const deckOverlay = new deck.MapboxOverlay({ interleaved:true, layers:[] });
    map.addControl(deckOverlay);

    // ---------- state ----------
    let rawData=null, filtered=null, breaks=null, activeAttr=CONFIG.ATTR_DEFAULT;
    let currentRenderer = "clusters"; // clusters | heatmap | hexgrid
    const layerModeLabel = document.getElementById("layerModeLabel");

    // ---------- sample data with Job Type + Date ----------
    function generateSampleData(){
      const rows = [
        { city:"Amsterdam",  company:"Leaseweb",    lat:52.3667, lon:4.8945, job:"SAP Functional Application Manager", type:"Hybrid",  date:"2025-03-03", salary:89582, exp:2 },
        { city:"Amsterdam",  company:"Deloitte",    lat:52.3667, lon:4.8945, job:"Junior SAP Consultant",             type:"On-site", date:"2025-03-07", salary:65754, exp:3 },
        { city:"Lieshout",   company:"Royal Swinkels", lat:51.5194, lon:5.5958, job:"Junior SAP Application Manager", type:"On-site", date:"2025-03-02", salary:89834, exp:2 },
        { city:"Utrecht",    company:"Billennium",  lat:52.0907, lon:5.1214, job:"SAP Consultant (Remote)",           type:"Remote",  date:"2025-03-01", salary:68849, exp:3 },
        { city:"Eindhoven",  company:"SixteenFifty",lat:51.4416, lon:5.4697, job:"SAP MM Support Consultant",          type:"Hybrid",  date:"2025-03-06", salary:72918, exp:3 }
      ];
      return { type:"FeatureCollection", features: rows.map((r,i)=>({
        type:"Feature",
        geometry:{ type:"Point", coordinates:[r.lon,r.lat] },
        properties:{
          id:i, name:r.job, company:r.company, country:"NL",
          count:1, salary:r.salary, experience:r.exp,
          type:r.type, date:r.date
        }
      }))};
    }

    // ---------- cluster / heatmap / point layers ----------
    const SRC = "jobsSrc";
    const L_CLUSTER = "cluster-circles";
    const L_CLUSTER_TXT = "cluster-text";
    const L_POINTS = "points";
    const L_HEAT = "heat";

    function paletteStepExpression(valueExpr){
      // build a step() with current breaks & palette
      const steps = ["step", valueExpr, CONFIG.PALETTE[0]];
      for(let i=0;i<breaks.length;i++){
        steps.push(breaks[i], CONFIG.PALETTE[i+1]);
      }
      return steps;
    }

    function ensureSourceAndLayers(){
      if(!map.getSource(SRC)){
        map.addSource(SRC, {
          type:"geojson",
          data:{type:"FeatureCollection", features:[]},
          cluster:true, clusterRadius:CONFIG.CLUSTER_RADIUS, clusterMaxZoom:CONFIG.CLUSTER_MAX_ZOOM,
          // aggregate sums for properties so we can color clusters by avg salary/exp, etc.
          clusterProperties:{
            sum_salary: ["+", ["accumulated"], ["to-number", ["get","salary"]]],
            sum_experience: ["+", ["accumulated"], ["to-number", ["get","experience"]]],
            sum_count: ["+", ["accumulated"], ["to-number", ["get","count"]]]
          }
        });

        // clustered bubbles
        map.addLayer({
          id:L_CLUSTER, type:"circle", source:SRC, filter:["has","point_count"],
          paint:{
            "circle-color": ["case",
              ["==", ["var","mode"], "salary"], paletteStepExpression(["/", ["get","sum_salary"], ["get","point_count"]]),
              ["==", ["var","mode"], "experience"], paletteStepExpression(["/", ["get","sum_experience"], ["get","point_count"]]),
              // default count
              paletteStepExpression(["get","point_count"])
            ],
            "circle-radius": ["interpolate", ["linear"], ["get","point_count"], 1, 14, 100, 34],
            "circle-opacity": 0.9,
            "circle-stroke-color":"#0F1115","circle-stroke-width":2
          }
        }, undefined, {"mode": activeAttr});

        map.addLayer({
          id:L_CLUSTER_TXT, type:"symbol", source:SRC, filter:["has","point_count"],
          layout:{ "text-field":["to-string",["get","point_count"]], "text-size":12 },
          paint:{ "text-color":"#fff" }
        });

        // individual points
        map.addLayer({
          id:L_POINTS, type:"circle", source:SRC, filter:["!",["has","point_count"]],
          paint:{
            "circle-color": ["case",
              ["==", ["var","mode"], "salary"], paletteStepExpression(["to-number",["get","salary"]]),
              ["==", ["var","mode"], "experience"], paletteStepExpression(["to-number",["get","experience"]]),
              paletteStepExpression(["to-number",["get","count"]])
            ],
            "circle-radius": ["to-number", ["var","ptRadius"], 6],
            "circle-opacity": ["to-number", ["var","ptOpacity"], 0.85],
            "circle-stroke-color":"#0F1115","circle-stroke-width":1.5
          }
        }, undefined, {"mode": activeAttr, "ptRadius": +document.getElementById("radiusRange").value, "ptOpacity": +document.getElementById("opacityRange").value/100 });

        // popups on points
        map.on("click", L_POINTS, e=>{
          const f = e.features?.[0]; if(!f) return;
          const p = f.properties;
          new maplibregl.Popup({closeOnMove:true, offset:12})
            .setLngLat(f.geometry.coordinates)
            .setHTML(`
              <div style="min-width:220px">
                <div class="font-semibold mb-1">${p.name}</div>
                <div class="text-xs text-muted mb-1">${p.company}</div>
                <div class="text-sm">Jobs: <b>${p.count}</b> · Salary: <b>€${fmt(+p.salary||0)}</b> · Exp: <b>${p.experience}y</b></div>
                <div class="text-sm">Type: <b>${p.type||""}</b> · Date: <b>${p.date||""}</b></div>
                <div class="text-[11px] text-muted mt-1">${f.geometry.coordinates[1].toFixed(4)}, ${f.geometry.coordinates[0].toFixed(4)}</div>
              </div>`)
            .addTo(map);
        });

        // click cluster -> fit ALL leaves so they are dispersed and visible
        map.on("click", L_CLUSTER, e=>{
          const feat = e.features?.[0]; if(!feat) return;
          const src = map.getSource(SRC);
          src.getClusterLeaves(feat.properties.cluster_id, Infinity, 0, (err, leaves)=>{
            if(err || !leaves?.length) return;
            const fc = { type:"FeatureCollection", features: leaves };
            const bbox = turf.bbox(fc);
            map.fitBounds([[bbox[0],bbox[1]],[bbox[2],bbox[3]]], { padding: 120, duration: 600, maxZoom: 18 });
          });
        });

        map.on("mouseenter", L_CLUSTER, ()=> map.getCanvas().style.cursor="pointer");
        map.on("mouseleave", L_CLUSTER, ()=> map.getCanvas().style.cursor="");
        map.on("mouseenter", L_POINTS, ()=> map.getCanvas().style.cursor="pointer");
        map.on("mouseleave", L_POINTS, ()=> map.getCanvas().style.cursor="");
      }

      // heatmap layer
      if(!map.getLayer(L_HEAT)){
        map.addLayer({
          id: L_HEAT, type: "heatmap", source: SRC,
          paint: {
            "heatmap-radius": 30,
            "heatmap-opacity": 0.9,
            "heatmap-intensity": 1.2,
            "heatmap-weight": ["case",
              ["==", ["var","mode"], "salary"], ["interpolate", ["linear"], ["to-number",["get","salary"]], breaks[0], 0.1, breaks.at(-1), 1],
              ["==", ["var","mode"], "experience"], ["interpolate", ["linear"], ["to-number",["get","experience"]], breaks[0], 0.1, breaks.at(-1), 1],
              // count weight defaults to 1 per point
              1
            ],
            "heatmap-color": [
              "interpolate", ["linear"], ["heatmap-density"],
              0, "rgba(0,0,0,0)",
              0.2, "#2b7bff",
              0.4, "#3aa0ff",
              0.6, "#ffd166",
              0.8, "#ff8c42",
              1, "#ff4d4d"
            ]
          }
        }, L_POINTS, {"mode": activeAttr});
        map.setLayoutProperty(L_HEAT, "visibility", "none");
      }
    }

    function updateSourceData(fc){ if(map.getSource(SRC)) map.getSource(SRC).setData(fc); }

    function setLayerVisibility(renderer){
      currentRenderer = renderer;
      layerModeLabel.textContent = renderer === "clusters" ? "Clusters / Points" : renderer === "heatmap" ? "Heatmap" : "Hex grid (labels)";
      const vis = (id, show)=>{ if(map.getLayer(id)) map.setLayoutProperty(id, "visibility", show?"visible":"none"); };
      if(renderer==="clusters"){
        vis(L_HEAT,false); vis(L_CLUSTER,true); vis(L_CLUSTER_TXT,true); vis(L_POINTS,true); deckOverlay.setProps({layers:[]});
      } else if(renderer==="heatmap"){
        vis(L_HEAT,true); vis(L_CLUSTER,false); vis(L_CLUSTER_TXT,false); vis(L_POINTS,false); deckOverlay.setProps({layers:[]});
      } else { // hexgrid via deck.gl
        vis(L_HEAT,false); vis(L_CLUSTER,false); vis(L_CLUSTER_TXT,false); vis(L_POINTS,false);
        renderHexGrid();
      }
    }

    // ---------- classification / filters ----------
    function recomputeColoring(){
      const vals = filtered.features.map(f=>Number(f.properties[activeAttr])).filter(Number.isFinite);
      if(vals.length===0){ breaks=[0,0,0,0]; return; }
      const method = document.getElementById("classSelect").value;
      breaks = method==="equal" ? equalBreaks(vals, CONFIG.PALETTE.length) : quantiles(vals, CONFIG.PALETTE.length);
      document.getElementById("legendRamp").innerHTML = CONFIG.PALETTE.map(c=>`<div style="flex:1;background:${c}"></div>`).join("");
      const labs=[Math.min(...vals),...breaks,Math.max(...vals)];
      document.getElementById("legendLabels").innerHTML = `<span>${fmt(Math.round(labs[0]))}</span><span>${fmt(Math.round(labs.at(-1)))}</span>`;

      // update style variables so circle/heatmap can react
      map.setLayerZoomRange?.(L_POINTS, 0, 24);
      // re-apply style variables used in paint via runtime styling vars
      map.setPaintProperty(L_POINTS, "circle-color", ["case",
        ["==", ["var","mode"], "salary"], paletteStepExpression(["to-number",["get","salary"]]),
        ["==", ["var","mode"], "experience"], paletteStepExpression(["to-number",["get","experience"]]),
        paletteStepExpression(["to-number",["get","count"]])
      ]);
      map.setPaintProperty(L_CLUSTER, "circle-color", ["case",
        ["==", ["var","mode"], "salary"], paletteStepExpression(["/", ["get","sum_salary"], ["get","point_count"]]),
        ["==", ["var","mode"], "experience"], paletteStepExpression(["/", ["get","sum_experience"], ["get","point_count"]]),
        paletteStepExpression(["get","point_count"])
      ]);
      map.setPaintProperty(L_HEAT, "heatmap-weight", ["case",
        ["==", ["var","mode"], "salary"], ["interpolate", ["linear"], ["to-number",["get","salary"]], breaks[0], 0.1, breaks.at(-1), 1],
        ["==", ["var","mode"], "experience"], ["interpolate", ["linear"], ["to-number",["get","experience"]], breaks[0], 0.1, breaks.at(-1), 1],
        1
      ]);
    }

    function applyFilters(){
      if(!rawData){ filtered={type:"FeatureCollection", features:[]}; return; }
      const iso=document.getElementById("countryFilter").value;
      const q =(document.getElementById("searchFilter").value||"").trim().toLowerCase();
      filtered = { type:"FeatureCollection", features: rawData.features.filter(f=>{
        const ok=!iso || f.properties.country===iso;
        const txt=`${f.properties.name} ${f.properties.company}`.toLowerCase();
        return ok && (!q || txt.includes(q));
      })};
    }

    // ---------- hex grid (vector enrichment) with labels ----------
    function renderHexGrid(){
      if(!filtered?.features?.length){ deckOverlay.setProps({layers:[]}); return; }
      const bbox = turf.bbox(filtered);
      const grid = turf.hexGrid(bbox, CONFIG.HEX_CELL_KM, {units:"kilometers"});
      const pts = turf.featureCollection(filtered.features.map(f=>turf.point(f.geometry.coordinates, f.properties)));
      const bins = [];
      grid.features.forEach((cell, idx)=>{
        const inside = turf.pointsWithinPolygon(pts, cell);
        const count = inside.features.length;
        if(count>0){
          cell.properties.count = count;
          bins.push(cell);
        }
      });
      const fc = turf.featureCollection(bins);
      // color scale by count
      const getColor = f=>{
        const cls = classify(f.properties.count, breaksForCounts(fc));
        const [r,g,b] = hexToRgb(CONFIG.PALETTE[cls]); return [r,g,b,220];
      };
      function breaksForCounts(fc){
        const arr = fc.features.map(f=>f.properties.count);
        if(arr.length===0) return [0,0,0,0];
        return quantiles(arr, CONFIG.PALETTE.length);
      }
      const polyLayer = new deck.GeoJsonLayer({
        id:"hex-polys", data: fc, stroked:false, filled:true, pickable:true,
        getFillColor: getColor, opacity: +document.getElementById("opacityRange").value/100
      });
      const labelData = fc.features.map(f=>({ position: turf.centroid(f).geometry.coordinates, label: String(f.properties.count) }));
      const textLayer = new deck.TextLayer({
        id:"hex-labels", data: labelData, pickable:false,
        getPosition: d=>d.position, getText: d=>d.label, getSize: 16, getColor:[255,255,255,255],
        getTextAnchor:'middle', getAlignmentBaseline:'center'
      });
      deckOverlay.setProps({ layers:[polyLayer, textLayer] });
    }

    // ---------- table (editable) ----------
    const drawer = document.getElementById("dataDrawer");
    const toggleTableBtn = document.getElementById("toggleTableBtn");
    const closeDrawer = document.getElementById("closeDrawer");
    const tableHead = document.getElementById("tableHead");
    const tableBody = document.getElementById("tableBody");
    const tableFilteredToggle = document.getElementById("tableFilteredToggle");
    const rowsPerPageSel = document.getElementById("rowsPerPage");
    const pageInfo = document.getElementById("pageInfo");
    const tableCount = document.getElementById("tableCount");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const exportCsvBtn = document.getElementById("exportCsv");

    const COLUMNS = [
      {key:"id", label:"ID", edit:false},
      {key:"name", label:"Title", edit:true},
      {key:"company", label:"Company", edit:true},
      {key:"country", label:"Country", edit:true},
      {key:"count", label:"Count", edit:true},
      {key:"salary", label:"Salary", edit:true},
      {key:"experience", label:"Exp", edit:true},
      {key:"type", label:"Type", edit:true},
      {key:"date", label:"Date", edit:true},
      {key:"lat", label:"Lat", edit:true},
      {key:"lon", label:"Lon", edit:true}
    ];
    let sortKey="name", sortAsc=true, page=1;

    function toggleDrawer(open){ drawer.classList.toggle("open", open ?? !drawer.classList.contains("open")); drawer.setAttribute("aria-hidden", drawer.classList.contains("open")?"false":"true"); }
    function currentFeatureList(){ return (tableFilteredToggle.checked ? (filtered?.features||[]) : (rawData?.features||[])); }
    function rowsFromFeatures(features){ return features.map(f=>({ id:f.properties.id, name:f.properties.name, company:f.properties.company, country:f.properties.country, count:+(f.properties.count||0), salary:+(f.properties.salary||0), experience:+(f.properties.experience||0), type:f.properties.type||"", date:f.properties.date||"", lat:+f.geometry.coordinates[1], lon:+f.geometry.coordinates[0], _f:f })); }

    function updateTable(){
      const size = Number(rowsPerPageSel.value||100);
      let rows = rowsFromFeatures(currentFeatureList());
      rows.sort((a,b)=>{ const va=a[sortKey], vb=b[sortKey]; if(va==null && vb==null) return 0; if(va==null) return 1; if(vb==null) return -1; if(typeof va==="number"&&typeof vb==="number") return sortAsc?va-vb:vb-va; return (sortAsc?1:-1)*String(va).localeCompare(String(vb)); });
      const total = rows.length; const totalPages=Math.max(1,Math.ceil(total/size)); if(page>totalPages) page=totalPages;
      const start=(page-1)*size, end=start+size, pageRows=rows.slice(start,end);
      tableHead.innerHTML = "<tr>"+COLUMNS.map(c=>`<th data-key="${c.key}">${c.label}${sortKey===c.key?(sortAsc?" ▲":" ▼"):""}</th>`).join("")+"</tr>";
      tableBody.innerHTML = pageRows.map(r=>{
        return `<tr data-id="${r.id}">
          ${COLUMNS.map(c=>{
            const val = c.key==="salary" ? (r.salary?`€${fmt(r.salary)}`:"") :
                        c.key==="lat" ? (isFinite(r.lat)? r.lat.toFixed(4) : "") :
                        c.key==="lon" ? (isFinite(r.lon)? r.lon.toFixed(4) : "") : (r[c.key]??"");
            const editable = c.edit ? 'contenteditable="true"' : '';
            return `<td data-key="${c.key}" ${editable}>${val}</td>`;
          }).join("")}
        </tr>`;
      }).join("");
      pageInfo.textContent = `${page} / ${totalPages}`; tableCount.textContent = `(${fmt(total)} rows)`;

      // sort click
      [...tableHead.querySelectorAll("th")].forEach(th=> th.onclick=()=>{ const k=th.dataset.key; if(k===sortKey) sortAsc=!sortAsc; else {sortKey=k; sortAsc=true;} updateTable(); });

      // edit handlers (blur to commit)
      tableBody.addEventListener("blur", onCellEdit, true);

      // row click -> fly
      [...tableBody.querySelectorAll("tr")].forEach(tr=>{
        tr.addEventListener("click", (ev)=>{
          if(ev.target.getAttribute("contenteditable")==="true") return;
          const id = +tr.getAttribute("data-id");
          const feat = (rawData?.features||[]).find(f=>f.properties.id===id);
          if(feat) map.flyTo({ center: feat.geometry.coordinates, zoom: 10 });
        });
      });
    }

    function onCellEdit(ev){
      const td = ev.target.closest("td"); if(!td) return;
      const tr = td.parentElement; const id = +tr.getAttribute("data-id");
      const key = td.getAttribute("data-key"); if(!key) return;
      const f = (rawData?.features||[]).find(x=>x.properties.id===id); if(!f) return;

      let val = td.textContent.trim();
      if(key==="salary" || key==="count" || key==="experience"){ val = Number(String(val).replace(/[^\d.-]/g,"")) || 0; f.properties[key]=val; }
      else if(key==="lat" || key==="lon"){
        const num = Number(val); if(isFinite(num)){
          const c = f.geometry.coordinates.slice();
          if(key==="lat") f.geometry.coordinates = [c[0], num]; else f.geometry.coordinates = [num, c[1]];
        }
      } else { f.properties[key] = val; }
      // re-apply filters/visuals
      applyFilters(); updateSourceData(filtered);
      if(currentRenderer==="hexgrid") renderHexGrid();
      recomputeColoring(); updateTable();
    }

    prevPageBtn.onclick = ()=>{ page=Math.max(1,page-1); updateTable(); };
    nextPageBtn.onclick = ()=>{ page=page+1; updateTable(); };
    rowsPerPageSel.onchange = ()=>{ page=1; updateTable(); };
    tableFilteredToggle.onchange = ()=>{ page=1; updateTable(); };
    exportCsvBtn.onclick = ()=>{
      const rows = rowsFromFeatures(currentFeatureList());
      const header = COLUMNS.map(c=>c.label).join(",");
      const csv = [header, ...rows.map(r => [r.id,r.name,r.company,r.country,r.count,r.salary,r.experience,r.type,r.date,r.lat,r.lon].map(v=>{
        if(v==null) return ""; const s=String(v).replace(/"/g,'""'); return /[",\n]/.test(s)?`"${s}"`:s;
      }).join(","))].join("\n");
      const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="jobs.csv"; a.click(); URL.revokeObjectURL(url);
    };
    document.getElementById("toggleTableBtn").onclick = ()=> toggleDrawer();
    document.getElementById("closeDrawer").onclick = ()=> toggleDrawer(false);
    window.addEventListener("keydown", (e)=>{ if(e.key.toLowerCase()==="t") toggleDrawer(); if(e.key==="Escape") toggleDrawer(false); });

    // ---------- UI listeners ----------
    function refreshAll(){
      recomputeColoring();
      updateSourceData(filtered);
      if(currentRenderer==="hexgrid") renderHexGrid();
      updateTable();
    }

    document.getElementById("rendererSelect").addEventListener("change", (e)=> { setLayerVisibility(e.target.value); });
    document.getElementById("attrSelect").addEventListener("change", (e)=>{ activeAttr=e.target.value; map.setPaintProperty(L_POINTS,"circle-color",["case",
      ["==", ["var","mode"], "salary"], paletteStepExpression(["to-number",["get","salary"]]),
      ["==", ["var","mode"], "experience"], paletteStepExpression(["to-number",["get","experience"]]),
      paletteStepExpression(["to-number",["get","count"]]) ]); map.setLayerProperty?.(L_POINTS, "mode", activeAttr); map.setLayerProperty?.(L_CLUSTER, "mode", activeAttr); map.setLayerProperty?.(L_HEAT, "mode", activeAttr); refreshAll();
    });
    document.getElementById("classSelect").addEventListener("change", refreshAll);
    document.getElementById("radiusRange").addEventListener("input", ()=>{ map.setLayerProperty?.(L_POINTS,"ptRadius", +document.getElementById("radiusRange").value); });
    document.getElementById("opacityRange").addEventListener("input", ()=>{ map.setLayerProperty?.(L_POINTS,"ptOpacity", +document.getElementById("opacityRange").value/100); });
    document.getElementById("blendToggle").addEventListener("change", ()=>{}); // visual only for deck layers

    document.getElementById("countryFilter").addEventListener("change", ()=>{ applyFilters(); refreshAll(); fitIfAny(); });
    document.getElementById("searchFilter").addEventListener("input", ()=>{ applyFilters(); refreshAll(); });

    document.querySelectorAll(".region-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{ document.querySelectorAll(".region-btn").forEach(b=>b.classList.remove("active")); btn.classList.add("active");
        const tag=btn.dataset.region; if(tag==="europe") map.fitBounds([[-25,35],[45,72]],{padding:50}); else if(tag==="nl") map.fitBounds([[3.2,50.5],[7.3,53.7]],{padding:60}); else fitIfAny();
      });
    });

    document.getElementById("btnAddLayer").addEventListener("click", ()=> document.getElementById("fileInput").click());
    document.getElementById("fileInput").addEventListener("change", (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=()=>{ try{
        let fc;
        if(f.name.toLowerCase().endsWith(".csv")){
          const parsed=Papa.parse(reader.result,{header:true, dynamicTyping:true, skipEmptyLines:true});
          fc=csvToGeoJSON(parsed.data);
        }else{
          const json=JSON.parse(reader.result);
          fc=json.type==="FeatureCollection"?json:{type:"FeatureCollection",features:json.features??[]};
        }
        rawData=fc; applyFilters(); updateSourceData(filtered); renderHexGrid(); recomputeColoring(); setLayerVisibility(currentRenderer); fitIfAny(); updateTable();
      }catch(err){ alert("Failed to load file: "+err.message); } };
      reader.readAsText(f);
    });

    document.getElementById("visualizeJobsBtn").addEventListener("click", async ()=>{
      const text=(document.getElementById("jobDataInput").value||"").trim();
      if(!text){ alert("Paste some rows first."); return; }
      const parsed=Papa.parse(text,{header:true, dynamicTyping:true, skipEmptyLines:true});
      let fc=csvToGeoJSON(parsed.data);
      if(fc.features.length===0){
        const locKey=document.getElementById("locationColumn").value;
        const titleKey=document.getElementById("titleColumn").value;
        const cache=new Map(); const feats=[];
        for(const row of parsed.data){
          const loc=row[locKey]; const title=row[titleKey];
          if(!loc || !title) continue;
          let coords=cache.get(loc); if(!coords){ try{ const nom=`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(loc)}&limit=1`; const res=await fetch(nom); const j=await res.json(); coords=j?.[0]?[+j[0].lon,+j[0].lat]:null; cache.set(loc,coords);}catch(e){ coords=null; } }
          if(coords){ feats.push({ type:"Feature", geometry:{type:"Point",coordinates:coords},
            properties:{ id:feats.length, name:title, company: row.company ?? row.employer ?? "", country: row.country ?? "", count: Number(row.count)||1, salary: Number(row.salary)||0, experience: Number(row.experience)||0, type: row.type||"", date: row.date||"" } }); }
        }
        fc={type:"FeatureCollection",features:feats};
      }
      if(fc.features.length===0){ alert("No mappable rows found."); return; }
      rawData=fc; applyFilters(); refreshAll(); setLayerVisibility(currentRenderer); fitIfAny();
    });

    function csvToGeoJSON(rows){
      const header = Object.keys(rows[0]||{}).reduce((m,k)=>{ m[k.toLowerCase()]=k; return m; },{});
      const lonK=header.longitude||header.lon||header.lng||header.x;
      const latK=header.latitude||header.lat||header.y;
      const features=[];
      for(let i=0;i<rows.length;i++){
        const r=rows[i], lon=Number(r[lonK]), lat=Number(r[latK]);
        if(Number.isFinite(lon) && Number.isFinite(lat)){
          features.push({ type:"Feature", geometry:{type:"Point",coordinates:[lon,lat]},
            properties:{ id: r.id ?? i, name: r.title ?? r.job_title ?? r.role ?? r.name ?? "Job",
              company: r.company ?? r.employer ?? "", country: r.country ?? "", count: Number(r.count ?? 1) || 1,
              salary: Number(r.salary ?? r.pay ?? 0) || 0, experience: Number(r.experience ?? r.exp ?? 0) || 0,
              type: r.type || "", date: r.date || "" } });
        }
      }
      return { type:"FeatureCollection", features };
    }

    function fitIfAny(){ if(filtered?.features?.length){ const b=turf.bbox(filtered); map.fitBounds([[b[0],b[1]],[b[2],b[3]]],{padding:100,duration:600}); } }

    // ---------- init ----------
    map.on("load", ()=>{
      ensureSourceAndLayers();
      rawData = generateSampleData();
      applyFilters();
      updateSourceData(filtered);
      setLayerVisibility("clusters");
      recomputeColoring();
      fitIfAny();
      updateTable();
    });

    feather.replace();
  </script>
</body>
</html>
